# セッション
- HTTPはステートレス(Stateless)なプロトコルで、1回毎で独立していて前回の状態は保持できない
- そこで、セッション情報をWebブラウザとサーバで保持することで状態を管理する

例)  
https://railstutorial.jp/chapters/basic_login?version=5.1
```
昔は離れた相手と一手ずつ葉書をやりとりしてのんびりと将棋を指す酔狂な人がときどきいましたが、将棋の対戦を１つのセッションと考えれば、その下の郵便システムはHTTP同様ステートレスであり、対戦者同士が盤の状態を保持していれば、郵便システムや郵便配達夫が対戦の進行や内容に一切かかわらなくてもゲームは成立します
```

- Railsでは[cookies](https://ja.wikipedia.org/wiki/HTTP_cookie)を使ってセッションを一般的に実装する

## session メソッド
- sessionメソッドを使用しすると、自動で一時cookiesが生成される
- sessionメソッドで保存した情報はブラウザを閉じると消える

## Remember me機能
- sessionメソッドで保存した情報はブラウザを閉じると消えるので、セッションを永続化するために`cookies`メソッドを使用する
- `cookies`メソッドで保存する情報は安全が保たれていない
  1. 管理の甘いネットワークを通過するネットワークパケットからパケットスニッファという特殊なソフトウェアで直接cookieを取り出す1 。
  2. データベースから記憶トークンを取り出す。
  3. クロスサイトスクリプティング (XSS) を使う。
  4. ユーザーがログインしているパソコンやスマホを直接操作してアクセスを奪い取る。

- 対策
  1. SSLをサイト全体に適用する
  2. トークンのハッシュを保存する
  3. Railsによって自動的に対策が行われる
  4. 根本的な対策は不可能なので、ユーザが別端末でログアウトしたときにトークンを必ず変更すし、
  セキュリティ上重要になる可能性のある情報を表示するときは、デジタル署名を行うようにする。

- `cookies`メソッドはハッシュとして扱える
- 個別の`cookies`は`value`とオプションの`expires`(有効期限)からできている
- cookiesの有効期限を20年後に設定すると永続的なセッションを作ることができる　20年後に有効期限が切れるが、なぜ20年かわわからない

## ログアウト
- Sessionとcookiesを削除し、RememberMe機能のリメンバーダイジェストを削除する

## バグ
- 2つのタブでログアウトをした場合に、１回目のログアウトでSessionとcookiesを削除しているので２回めのログアウトで、カレントユーザが取得できず(nil)にエラーになる  
  修正：ログアウトメッソドでログアウトする前に、ログイン中か確認する


- 別のブラウザで同時にログインしている場合に、１つ目のブラウザでログアウトして、もう一つのブラウザを開くとDBに保存されているリメンバーダイジェストがnilになるためエラーになる
  修正：リメンバーダイジェストが存在したい場合は認証しない

## SecureRandom#urlsafe_base64
- A–Z、a–z、0–9、"-"、"_"のいずれかの文字 (64種類) からなる長さ22のランダムな文字列を返します (64種類なのでbase64と呼ばれています)
